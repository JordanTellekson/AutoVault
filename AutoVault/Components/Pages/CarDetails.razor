@page "/cars/{CarId:guid}"
@using AutoVault.Models
@inject AutoVault.Services.ICarRepository CarRepository
@inject NavigationManager Navigation

<ConfirmDialog @ref="_confirmDialog" 
               Message="Are you sure you want to delete this maintenance record?" 
               OnClose="OnDeleteConfirmed" />

@if (_car is null)
{
    <p>Loading…</p>
}
else
{
    <div class="car-details-page">
        <button class="custom-button" @onclick="GoBack">← Back to Collection</button>

        <div class="car-details-card">
            <img src="@_car.ImagePath" alt="@($"{_car.Make} {_car.Model}")" class="car-details-image" />

            <div class="car-info">
                <h2>@($"{_car.Year} {_car.Make} {_car.Model} {_car.Trim} {_car.Performance.Drivetrain}")</h2>
                <h3><strong>Value: $@_car.Price.ToString("N2")</strong></h3>
                @if (_car.Vin == string.Empty)
                {
                    <p><strong>No VIN Provided</strong></p>
                }
                else
                {
                    <p><strong>VIN:</strong> @_car.Vin</p>
                }
                <p><strong>Mileage:</strong> @_car.Mileage.ToString("N0")</p>

                <h3>Engine</h3>
                @{
                    string engineType = _car.Engine.Turbocharged && _car.Engine.Supercharged ? "Twincharged"
                                        : _car.Engine.Turbocharged ? "Turbocharged"
                                        : _car.Engine.Supercharged ? "Supercharged"
                                        : "Naturally Aspirated";
                }
                <p><strong>@($"{engineType} {_car.Engine.DisplacementLiters}L {_car.Engine.Cylinders} Cyl outputting {_car.Performance.Horsepower.ToString("N0")} Horsepower")</strong></p>
                <p><strong>MPG:</strong> @_car.Mpg</p>
                <p><strong>Fuel type:</strong> @_car.Engine.FuelType</p>

                <h3>Performance</h3>
                <p><strong>0-60 mph:</strong> @_car.Performance.ZeroToSixty s</p>
                <p><strong>Top Speed:</strong> @_car.Performance.TopSpeed.ToString("N0") mph</p>

                <h3>Miscellaneous</h3>
                <p><strong>Color:</strong> @_car.Color</p>
                <p><strong>Transmission:</strong> @_car.Transmission</p>
                <p><strong>Torque:</strong> @_car.Torque lb-ft</p>
                <p><strong>Carbon Fiber:</strong> @(_car.HasCarbonFiber ? "Yes" : "No")</p>

                <h3>Maintenance Records</h3>
                @if (_car.Maintenance != null && _car.Maintenance.Count > 0)
                {
                    <ul>
                        @foreach (var record in _car.Maintenance)
                        {
                            <li>
                                <div>
                                    <strong>@record.Date.ToShortDateString()</strong> — @record.Description
                                    (@record.MileageAtService.ToString("N0") miles) — $@record.Cost.ToString("N2")
                                </div>
                                <div style="margin-top:0.5rem;">
                                    <button class="custom-button" @onclick="() => EditMaintenance(record.Id)">Edit</button>
                                    <button class="custom-button" @onclick="() => ConfirmDelete(record.Id)">Delete</button>
                                </div>
                            </li>
                        }
                    </ul>
                    <div class="maintenance-actions">
                        <button class="custom-button" @onclick="AddMaintenance">Add Record</button>
                    </div>
                }
                else
                {
                    <div class="maintenance-empty">
                        <p>There are no Maintenance Records attached to this vehicle. Would you like to add one?</p>
                        <div class="maintenance-actions">
                            <button class="custom-button" @onclick="AddMaintenance">Add Record</button>
                        </div>
                    </div>
                }
            </div> <!-- .car-info -->
        </div> <!-- .car-details-card -->
    </div> <!-- .car-details-page -->
}

@code {
    [Parameter] public Guid CarId { get; set; }

    private Car? _car;
    private Guid _recordToDelete;
    private ConfirmDialog? _confirmDialog;

    protected override async Task OnInitializedAsync()
    {
        _car = await CarRepository.GetCarByIdAsync(CarId);

        if (_car?.Maintenance != null)
        _car.Maintenance = _car.Maintenance
                               .OrderBy(r => r.Date)
                               .ToList();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/cars");
    }

    private void AddMaintenance()
    {
        Navigation.NavigateTo($"/cars/{CarId}/maintenance/new");
    }

    private void EditMaintenance(Guid recordId)
    {
        Navigation.NavigateTo($"/cars/{CarId}/maintenance/edit/{recordId}");
    }

    private void ConfirmDelete(Guid recordId)
    {
        _recordToDelete = recordId;
        _confirmDialog?.Show();
    }

    private async Task OnDeleteConfirmed(bool confirmed)
    {
        if (!confirmed) return;

        var record = _car?.Maintenance.FirstOrDefault(r => r.Id == _recordToDelete);
        if (record == null) return;

        _car.Maintenance.Remove(record);
        await CarRepository.UpdateCarAsync(_car);
    }
}